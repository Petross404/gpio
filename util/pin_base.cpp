////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2018 Dimitry Ishenko
// Contact: dimitry (dot) ishenko (at) (gee) mail (dot) com
//
// Distributed under the GNU GPL license. See the LICENSE.md file for details.

////////////////////////////////////////////////////////////////////////////////
#include "chip_base.hpp"
#include "pin_base.hpp"

#include <algorithm>
#include <utility>

////////////////////////////////////////////////////////////////////////////////
namespace gpio
{

////////////////////////////////////////////////////////////////////////////////
pin_base::pin_base(gpio::chip* chip, gpio::pos n) noexcept :
    chip_(chip), pos_(n)
{ }

////////////////////////////////////////////////////////////////////////////////
pin_base::~pin_base() { }

////////////////////////////////////////////////////////////////////////////////
void pin_base::period(nsec period)
{
    period_ = std::max(period, 1ns);
}

////////////////////////////////////////////////////////////////////////////////
void pin_base::pulse(nsec pulse)
{
    pulse_ = std::min(std::max(pulse, 0ns), period_);
}

////////////////////////////////////////////////////////////////////////////////
void pin_base::duty_cycle(percent pc)
{
    pc = std::max(0_pc, std::min(pc, 100_pc));
    pulse(nsec( static_cast<nsec::rep>(period_.count() * pc / 100_pc + 0.5) ));
}

////////////////////////////////////////////////////////////////////////////////
percent pin_base::duty_cycle() const noexcept
{
    return 100_pc * pulse_.count() / period_.count();
}

////////////////////////////////////////////////////////////////////////////////
cid pin_base::on_state_changed(fn_state_changed fn)
{
    return state_changed_.add(std::move(fn));
}

////////////////////////////////////////////////////////////////////////////////
cid pin_base::on_state_on(fn_state_on fn)
{
    return on_state_changed(
        [fn_ = std::move(fn)](gpio::state state)
        { if(state == on) fn_(); }
    );
}

////////////////////////////////////////////////////////////////////////////////
cid pin_base::on_state_off(fn_state_off fn)
{
    return on_state_changed(
        [fn_ = std::move(fn)](gpio::state state)
        { if(state == off) fn_(); }
    );
}

////////////////////////////////////////////////////////////////////////////////
bool pin_base::remove(cid id)
{
    return state_changed_.remove(id);
}

////////////////////////////////////////////////////////////////////////////////
}
