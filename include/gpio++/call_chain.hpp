////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2018 Dimitry Ishenko
// Contact: dimitry (dot) ishenko (at) (gee) mail (dot) com
//
// Distributed under the GNU GPL license. See the LICENSE.md file for details.

////////////////////////////////////////////////////////////////////////////////
#ifndef GPIO_CALL_CHAIN_HPP
#define GPIO_CALL_CHAIN_HPP

////////////////////////////////////////////////////////////////////////////////
#include <gpio++/types.hpp>

#include <map>
#include <utility>

////////////////////////////////////////////////////////////////////////////////
namespace gpio
{

////////////////////////////////////////////////////////////////////////////////
cid get_seed();

////////////////////////////////////////////////////////////////////////////////
template<typename Fn>
struct call_chain
{
    ////////////////////
    call_chain() = default;

    call_chain(const call_chain&) = delete;
    call_chain& operator=(const call_chain&) = delete;

    ////////////////////
    cid add(Fn fn)
    {
        cid id = seed_++;
        chain_.emplace(id, std::move(fn));
        return id;
    }
    bool remove(cid id) { return chain_.erase(id); }

    template<typename... Args>
    void operator()(Args&&... args)
    { for(auto const& fn : chain_) fn.second(std::forward<Args>(args)...); }

private:
    ////////////////////
    cid seed_ = get_seed();
    std::map<cid, Fn> chain_;
};

////////////////////////////////////////////////////////////////////////////////
inline cid get_seed()
{
    static int seed = 0;
    return cid(seed++, 0);
}

////////////////////////////////////////////////////////////////////////////////
}

////////////////////////////////////////////////////////////////////////////////
#endif
